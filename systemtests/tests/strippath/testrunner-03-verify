#!/bin/bash
set -e
set -o pipefail
set -u

TestName=03-verify

JobName=backup-bareos-fd
VerifyJobName=verify-bareos-fd

#shellcheck source=../environment.in
. ./environment

#shellcheck source=../scripts/functions
. "${rscripts}"/functions

# Create verify job
cat <<END_OF_DATA > "$config_directory_dir_additional_test_config/strippath-verify-job.conf"
Job {
  Name = "$VerifyJobName"
  JobDefs = "DefaultJob"
  Client = "bareos-fd"
  FileSet = "SelfTestStripPath"
  Type = Verify
  Level = DiskToCatalog
  Verify Job = "$JobName"
}
END_OF_DATA

start_test

cat <<END_OF_DATA >"$tmp/bconcmds"
@$out /dev/null
messages
@$out $tmp/reload.out
reload
messages
@$out $tmp/verify.out
run job=$VerifyJobName yes
wait
messages
quit
END_OF_DATA

run_bareos "$@"

check_for_zombie_jobs storage=File

expect_grep 'Termination:.*Verify OK' \
	    "$tmp/verify.out" \
	    "Verify job failed or unexpectedly found differences."

end_test
