#!/bin/bash
set -e
set -o pipefail
set -u

TestName=03-verify

JobName=backup-bareos-fd

#shellcheck source=../environment.in
. ./environment

#shellcheck source=../scripts/functions
. "${rscripts}"/functions

# Create verify job
cat <<END_OF_DATA > "$config_directory_dir_additional_test_config/strippath-verify-job.conf"
Job {
  Name = "verify-initcatalog-bareos-fd"
  JobDefs = "DefaultJob"
  Client = "bareos-fd"
  FileSet = "SelfTestStripPath"
  Type = Verify
  Level = InitCatalog
}
Job {
  Name = "verify-catalog-bareos-fd"
  JobDefs = "DefaultJob"
  Client = "bareos-fd"
  FileSet = "SelfTestStripPath"
  Type = Verify
  Level = Catalog
}
Job {
  Name = "verify-disktocatalog-bareos-fd"
  JobDefs = "DefaultJob"
  Client = "bareos-fd"
  FileSet = "SelfTestStripPath"
  Type = Verify
  Level = DiskToCatalog
  Verify Job = "$JobName"
}
Job {
  Name = "verify-volumetocatalog-bareos-fd"
  JobDefs = "DefaultJob"
  Client = "bareos-fd"
  FileSet = "SelfTestStripPath"
  Type = Verify
  Level = VolumeToCatalog
}
END_OF_DATA

start_test

cat <<END_OF_DATA >"$tmp/bconcmds"
@$out /dev/null
messages
@$out $tmp/reload.out
reload
messages
@$out $tmp/verify-initcatalog.out
run job="verify-initcatalog-bareos-fd" yes
wait
messages
@$out $tmp/verify-catalog.out
run job="verify-catalog-bareos-fd" jobid=3 yes
wait
messages
@$out $tmp/verify-disktocatalog.out
run job="verify-disktocatalog-bareos-fd" yes
wait
messages
@$out $tmp/verify-volumetocatalog.out
run job="verify-volumetocatalog-bareos-fd" yes
wait
messages
quit
END_OF_DATA

run_bareos "$@"

check_for_zombie_jobs storage=File

expect_grep 'Termination:.*Verify OK' \
	    "$tmp/verify-initcatalog.out" \
	    "Verify Init job failed."

expect_grep 'Termination:.*Verify OK' \
	    "$tmp/verify-catalog.out" \
	    "Verify Catalog job failed or unexpectedly found differences."

expect_grep 'Termination:.*Verify OK' \
	    "$tmp/verify-disktocatalog.out" \
	    "Verify DiskToCatalog job failed or unexpectedly found differences."

expect_grep 'Termination:.*Verify OK' \
	    "$tmp/verify-volumetocatalog.out" \
	    "Verify VolumeToCatalog job failed or unexpectedly found differences."

end_test
