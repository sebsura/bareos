#!/bin/bash
set -e
set -o pipefail
set -u

TestName="$(basename "$(pwd)")"
export TestName

bstat=0
dstat=0
estat=0
rstat=0
zstat=0

#shellcheck source=../environment.in
. ./environment

#shellcheck source=../scripts/functions
. "${rscripts}"/functions
"${rscripts}"/cleanup

setup_data

selftest_log="$tmp"/selftest_log.out
wildcard_log="$tmp"/wildcard_log.out
error_log="$logdir"/bareos.log

./sbin/testfind-testfind -c etc/bareos -f SelfTest > "$selftest_log"

expect_grep "Number of files examined: 55" \
            "$selftest_log" \
            "Number of files is incorrect."

unopenable_dir=${tmp}/data/unopenable_dir
mkdir -m 000 "$unopenable_dir"

./sbin/testfind-testfind -c etc/bareos -f Wildtest > "$wildcard_log"

expect_grep "Number of files examined: 19" \
            "$wildcard_log" \
            "Number of files is incorrect."

if [ $(whoami) != "root" ]; then
    expect_grep "\"$unopenable_dir\": ERR=Permission denied" \
                "$error_log" \
                "Error on faulty directory not detected."
fi

end_test
